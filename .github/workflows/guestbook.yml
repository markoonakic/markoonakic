name: Guestbook

on:
  issue_comment:
    types: [created, edited, deleted]

permissions:
  contents: write

jobs:
  update_guestbook:
    name: Update guestbook
    if: ${{ github.event.issue.title == 'Guestbook' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Update guestbook from comments
        uses: actions/github-script@v6
        with:
          script: |
            const truncateString = (str, num) =>
              str.length > num ? str.slice(0, num) + "..." : str;

            const query = `query($owner:String!, $name:String!, $issue_number:Int!) {
              repository(owner:$owner, name:$name){
                issue(number:$issue_number) {
                  comments(first:5, orderBy:{direction:DESC, field:UPDATED_AT}) {
                    nodes {
                      author { avatarUrl(size: 24) login url }
                      bodyText
                      updatedAt
                    }
                  }
                }
              }
            }`;
            const variables = {
              owner: context.repo.owner,
              name: context.repo.repo,
              issue_number: context.issue.number
            };

            const result = await github.graphql(query, variables);

            const renderComments = (comments) => {
              return comments.reduce((prev, curr) => {
                let text = curr.bodyText
                  .replace(/(\r\n|\r|\n)/g, "<br />")
                  .replace('|', '|');
                text = truncateString(text, 125);
                return `${prev}| <a href="${curr.author.url}"><img width="24" src="${curr.author.avatarUrl}" alt="${curr.author.login}" /> ${curr.author.login}</a> |${new Date(curr.updatedAt).toLocaleString()}|${text}|\n`;
              }, "| Name | Date | Message |\n|---|---|---|\n");
            };

            const fs = require('fs');
            const readme = fs.readFileSync('README.md', 'utf8');
            const table = renderComments(result.repository.issue.comments.nodes);
            fs.writeFileSync(
              'README.md',
              readme.replace(
                /(?<=<!-- Guestbook -->.*\n)[\S\s]*?(?=<!-- \/Guestbook -->|$(?![\n]))/gm,
                table
              ),
              'utf8'
            );

      - name: Push guestbook update
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git commit -am ':sparkles: update guestbook' || echo "No changes"
          git push
